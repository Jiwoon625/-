# -*- coding: utf-8 -*-
# app.py
from datetime import date
from io import StringIO
from pathlib import Path
import gzip, json, shutil, math

import numpy as np
import pandas as pd
import requests
import streamlit as st
from streamlit_folium import st_folium
import folium
from folium.plugins import MarkerCluster
import xgboost as xgb

# ───────────────────────────
# 페이지 설정 (가장 먼저 호출)
# ───────────────────────────
st.set_page_config(page_title="전세 보증금 예측", layout="wide")
st.title("전세 보증금 예측")

# ───────────────────────────
# 모델 다운로드 설정 (GitHub Releases)
# ───────────────────────────
MODEL_URL = "https://github.com/Jiwoon625/jeonse/releases/download/v1.0.2/jeonse_gbm_xgb.ubj.gz"
MODEL_DIR = Path("models"); MODEL_DIR.mkdir(exist_ok=True)
GZ_PATH = MODEL_DIR / "jeonse_gbm_xgb.ubj.gz"
UBJ_PATH = MODEL_DIR / "jeonse_gbm_xgb.ubj"

def _download_if_needed():
    if not GZ_PATH.exists() or GZ_PATH.stat().st_size == 0:
        with st.status("모델 다운로드 중...", expanded=False) as s:
            with requests.get(MODEL_URL, stream=True, timeout=300) as r:
                r.raise_for_status()
                tmp = GZ_PATH.with_suffix(".part")
                with open(tmp, "wb") as f:
                    for chunk in r.iter_content(1024*1024):
                        if chunk: f.write(chunk)
                tmp.replace(GZ_PATH)
            s.update(label="다운로드 완료", state="complete")

    if not UBJ_PATH.exists() or UBJ_PATH.stat().st_size == 0:
        with gzip.open(GZ_PATH, "rb") as fin, open(UBJ_PATH, "wb") as fout:
            shutil.copyfileobj(fin, fout)

@st.cache_resource
def load_model() -> xgb.Booster:
    _download_if_needed()
    bst = xgb.Booster()
    bst.load_model(str(UBJ_PATH))
    return bst

def get_feature_names_from_booster(bst: xgb.Booster):
    if getattr(bst, "feature_names", None):
        return list(bst.feature_names)
    for side in ["jeonse_gbm_xgb.flist", "jeonse_gbm_xgb.features.txt", "jeonse_gbm_features.csv"]:
        p = Path(side)
        if p.exists():
            return [ln.strip() for ln in p.read_text(encoding="utf-8").splitlines() if ln.strip()]
    return None

STATION_CSV = r"""name,line,lat,lon
동탄,수도권 광역급행철도,37.20034,127.09569
구성,수도권 광역급행철도,37.29913,127.10389
성남,수도권 광역급행철도,37.39467,127.12058
수서,수도권 광역급행철도,37.48637,127.10161
삼성,수도권 광역급행철도,37.50887,127.06324
서울,수도권 광역급행철도,37.55569,126.97296
연신내,수도권 광역급행철도,37.61878,126.9213
대곡,수도권 광역급행철도,37.63191,126.81113
킨텍스,수도권 광역급행철도,37.66532,126.74843
운정,수도권 광역급행철도,37.71614,126.72841
김포공항,김포골드라인,37.56236,126.801868
고촌,김포골드라인,37.601243,126.770345
풍무,김포골드라인,37.612488,126.732387
사우(김포시청),김포골드라인,37.620249,126.719731
걸포북변,김포골드라인,37.63165,126.705975
운양,김포골드라인,37.653867,126.68393
장기,김포골드라인,37.643986,126.669017
마산,김포골드라인,37.640732,126.644344
구래,김포골드라인,37.645384,126.628633
양촌,김포골드라인,37.642379,126.614309
원시,서해선,37.302371,126.786691
원곡,서해선,37.31321,126.796261
초지,서해선,37.319619,126.808147
선부,서해선,37.334353,126.809904
달미,서해선,37.348847,126.809409
시흥능곡,서해선,37.369864,126.808573
시흥시청,서해선,37.382223,126.805625
신현,서해선,37.409008,126.788017
신천,서해선,37.439066,126.786788
시흥대야,서해선,37.450145,126.793041
소새울,서해선,37.468467,126.797252
소사,서해선,37.483279,126.795023
신설동,우이신설선,37.576095,127.023242
보문,우이신설선,37.585286,127.019381
성신여대입구(돈암),우이신설선,37.592467,127.016516
정릉,우이신설선,37.603133,127.013396
북한산보국문,우이신설선,37.612072,127.008251
솔샘,우이신설선,37.620238,127.013626
삼양사거리,우이신설선,37.621337,127.020473
삼양,우이신설선,37.626914,127.018106
화계,우이신설선,37.634133,127.017511
가오리,우이신설선,37.641537,127.016789
4.19민주묘지,우이신설선,37.649502,127.013684
솔밭공원,우이신설선,37.65603,127.013273
북한산우이,우이신설선,37.662909,127.012706
탑석,의정부선,37.733579,127.088704
송산,의정부선,37.737279,127.087159
어룡,의정부선,37.742802,127.085035
곤제,의정부선,37.750471,127.083715
효자,의정부선,37.754025,127.076902
경기도청북부청사,의정부선,37.75059,127.071495
새말,의정부선,37.748885,127.06362
동오,의정부선,37.745271,127.056947
의정부중앙,의정부선,37.743676,127.049565
흥선,의정부선,37.743302,127.037023
의정부시청,의정부선,37.739256,127.034781
경전철의정부,의정부선,37.737202,127.043257
범골,의정부선,37.728755,127.04353
회룡,의정부선,37.725006,127.047073
발곡,의정부선,37.727048,127.052803
전대.에버랜드,에버라인선,37.285342,127.219561
둔전,에버라인선,37.267051,127.21364
보평,에버라인선,37.258965,127.218457
고진,에버라인선,37.24484,127.214251
운동장.송담대,에버라인선,37.237845,127.209198
김량장,에버라인선,37.237247,127.198781
명지대,에버라인선,37.237964,127.190294
시청.용인대,에버라인선,37.239151,127.178406
삼가,에버라인선,37.242115,127.168075
초당,에버라인선,37.260752,127.159443
동백,에버라인선,37.269043,127.152716
어정,에버라인선,37.274917,127.143714
지석,에버라인선,37.269606,127.136515
강남대,에버라인선,37.270161,127.126033
기흥,에버라인선,37.275449,127.116665
관악산(서울대),신림선,37.4691018,126.9450639
서울대벤처타운,신림선,37.4720019,126.9339351
서원,신림선,37.4782341,126.9330365
신림,신림선,37.4849266,126.9296159
당곡,신림선,37.4902998,126.9275133
보라매병원,신림선,37.4929598,126.9234964
보라매공원,신림선,37.4955691,126.9180827
보라매,신림선,37.5002739,126.9204355
서울지방병무청,신림선,37.5060464,126.9227083
대방,신림선,37.5133059,126.9257265
샛강,신림선,37.5170969,126.929399
광교(경기대),신분당선(연장),37.30211,127.044483
광교중앙(아주대),신분당선(연장),37.288617,127.051478
상현,신분당선(연장),37.297664,127.069342
성복,신분당선(연장),37.313335,127.0801
수지구청,신분당선(연장),37.322702,127.095026
동천,신분당선(연장),37.337928,127.102976
미금,신분당선(연장),37.349982,127.108918
정자,신분당선,37.367098,127.108403
판교,신분당선,37.394761,127.112217
청계산입구,신분당선,37.447211,127.055664
양재시민의숲(매헌),신분당선,37.470023,127.03842
양재(서초구청),신분당선,37.483809,127.034653
강남,신분당선,37.496837,127.028104
신논현,신분당선(연장2),37.504598,127.02506
논현,신분당선(연장2),37.511093,127.021415
신사,신분당선(연장2),37.516334,127.020114
영종,공항철도1호선,37.51202,126.524254
인천공항2터미널,공항철도1호선,37.460699,126.441442
인천공항1터미널,공항철도1호선,37.447464,126.452508
공항화물청사,공항철도1호선,37.459041,126.477516
운서,공항철도1호선,37.492904,126.49379
청라국제도시,공항철도1호선,37.556409,126.624648
검암,공항철도1호선,37.569098,126.674007
계양,공항철도1호선,37.571662,126.7363
김포공항,공항철도1호선,37.561842,126.801904
마곡나루,공항철도1호선,37.565543,126.827378
디지털미디어시티,공항철도1호선,37.576958,126.898609
홍대입구,공항철도1호선,37.557438,126.926715
공덕,공항철도1호선,37.54253,126.952024
서울역,공항철도1호선,37.553247,126.969769
중앙보훈병원,9호선(연장),37.529191,127.148739
둔촌오륜,9호선(연장),37.519683,127.137989
올림픽공원(한국체대),9호선(연장),37.516269,127.130288
한성백제,9호선(연장),37.516404,127.116503
송파나루,9호선(연장),37.510372,127.112216
석촌,9호선(연장),37.505208,127.10704
석촌고분,9호선(연장),37.502558,127.097033
삼전,9호선(연장),37.504738,127.088025
종합운동장,9호선(연장),37.511426,127.076275
봉은사,9호선(연장),37.514219,127.060245
삼성중앙,9호선(연장),37.513011,127.053282
선정릉,9호선(연장),37.510297,127.043999
언주,9호선(연장),37.507287,127.033868
신논현,9호선,37.504598,127.02506
사평,9호선,37.504206,127.015259
고속터미널,9호선,37.50598,127.004403
신반포,9호선,37.503415,126.995925
구반포,9호선,37.501364,126.987332
동작(현충원),9호선,37.502878,126.978153
흑석(중앙대입구),9호선,37.50877,126.963708
노들,9호선,37.512887,126.953222
노량진,9호선,37.513534,126.941005
샛강,9호선,37.517274,126.928422
여의도,9호선,37.52176,126.92403
국회의사당,9호선,37.528105,126.917874
당산,9호선,37.533406,126.902809
선유도,9호선,37.53802,126.893525
신목동,9호선,37.544277,126.88308
염창,9호선,37.546936,126.874916
등촌,9호선,37.550632,126.865689
증미,9호선,37.557402,126.861939
가양,9호선,37.561391,126.854456
양천향교,9호선,37.568381,126.841333
마곡나루,9호선,37.566778,126.82731
신방화,9호선,37.567532,126.816601
공항시장,9호선,37.563726,126.810678
김포공항,9호선,37.561916,126.802152
개화,9호선,37.578608,126.798153
석남(거북시장),7호선,37.5062285,126.6762813
산곡,7호선,37.5086,126.7035277
부평구청,7호선(인천),37.50848,126.72077
굴포천,7호선(인천),37.50681,126.73234
삼산체육관,7호선(인천),37.50724,126.74179
상동,7호선(인천),37.505814,126.753163
부천시청,7호선(인천),37.50444,126.76364
신중동,7호선(인천),37.50282,126.77566
춘의,7호선(인천),37.50365,126.78828
부천종합운동장,7호선(인천),37.50502,126.79661
까치울,7호선(인천),37.50613,126.81093
운연(서창),인천2호선,37.440127,126.75997
인천대공원,인천2호선,37.448769,126.752618
남동구청,인천2호선,37.448161,126.736939
만수,인천2호선,37.454911,126.732094
모래내시장,인천2호선,37.45583,126.719298
석천사거리,인천2호선,37.456805,126.709986
인천시청,인천2호선,37.456833,126.701306
석바위시장,인천2호선,37.457611,126.692575
시민공원(문화창작지대),인천2호선,37.458335,126.681192
주안,인천2호선,37.464992,126.679098
주안국가산단,인천2호선,37.473703,126.68113
가재울,인천2호선,37.484192,126.683673
인천가좌,인천2호선,37.4897,126.675208
서부여성회관,인천2호선,37.500168,126.675795
석남(거북시장),인천2호선,37.506193,126.676203
가정중앙시장,인천2호선,37.517054,126.676672
가정(루원시티),인천2호선,37.524649,126.675539
서구청,인천2호선,37.543742,126.676787
아시아드경기장(공촌사거리),인천2호선,37.5517,126.677122
검바위,인천2호선,37.561405,126.677566
검암,인천2호선,37.56866,126.675687
독정,인천2호선,37.585212,126.675844
완정,인천2호선,37.592928,126.673203
마전,인천2호선,37.597566,126.666998
검단사거리,인천2호선,37.60185,126.657108
왕길,인천2호선,37.59518,126.642696
검단오류(검단산업단지),인천2호선,37.594877,126.627178
송도달빛축제공원,인천1호선,37.407143,126.62597
국제업무지구,인천1호선,37.399907,126.630347
센트럴파크,인천1호선,37.393054,126.634729
인천대입구,인천1호선,37.386007,126.639484
지식정보단지,인천1호선,37.378384,126.645168
테크노파크,인천1호선,37.382268,126.656365
캠퍼스타운,인천1호선,37.387855,126.661673
동막,인천1호선,37.397878,126.674005
동춘,인천1호선,37.404737,126.681015
원인재,인천1호선,37.412333,126.687869
신연수,인천1호선,37.41804,126.693863
선학,인천1호선,37.426684,126.698863
문학경기장,인천1호선,37.434935,126.698579
인천터미널,인천1호선,37.442383,126.699706
예술회관,인천1호선,37.449396,126.701012
인천시청,인천1호선,37.457263,126.702143
간석오거리,인천1호선,37.467048,126.707938
부평삼거리,인천1호선,37.477679,126.710208
동수,인천1호선,37.485312,126.718247
부평,인천1호선,37.490535,126.723453
부평시장,인천1호선,37.498383,126.722244
부평구청,인천1호선,37.508407,126.720555
갈산,인천1호선,37.517268,126.721514
작전,인천1호선,37.530415,126.722527
경인교대입구,인천1호선,37.538157,126.722597
계산,인천1호선,37.543238,126.728128
임학,인천1호선,37.545059,126.738665
박촌,인천1호선,37.553703,126.745077
귤현,인천1호선,37.566379,126.742654
계양,인천1호선,37.571449,126.73578
남위례,8호선,37.4624,127.13977
모란,8호선,37.433824,127.129837
수진,8호선,37.437428,127.140722
신흥,8호선,37.440918,127.147564
단대오거리,8호선,37.44521,127.156866
남한산성입구(성남법원.검찰청),8호선,37.451535,127.159816
산성,8호선,37.457122,127.149908
복정,8호선,37.471052,127.126732
장지,8호선,37.478703,127.126191
문정,8호선,37.485855,127.1225
가락시장,8호선,37.492888,127.118398
송파,8호선,37.499703,127.112183
석촌,8호선,37.505557,127.106832
잠실(송파구청),8호선,37.514692,127.104338
몽촌토성(평화의문),8호선,37.517409,127.112359
강동구청,8호선,37.530341,127.120508
천호(풍납토성),8호선,37.538113,127.123254
암사,8호선,37.55021,127.127562
암사역사공원,8호선,37.55695,127.13702
장자호수공원,별내선,37.58738,127.13794
구리,별내선,37.60262,127.1407
동구릉,별내선,37.61105,127.13793
다산,별내선,37.62429,127.14973
별내,별내선,37.64232,127.1276
부평구청,7호선,37.507394,126.721599
굴포천,7호선,37.506997,126.73128
삼산체육관,7호선,37.506411,126.742153
상동,7호선,37.505781,126.753083
부천시청,7호선,37.504631,126.763538
신중동,7호선,37.503048,126.77596
춘의,7호선,37.503663,126.787036
부천종합운동장,7호선,37.50538,126.797337
까치울,7호선,37.506207,126.810939
온수(성공회대입구),7호선,37.492092,126.823023
천왕,7호선,37.486637,126.838713
광명사거리,7호선,37.479252,126.854876
철산,7호선,37.47605,126.867911
가산디지털단지,7호선,37.480338,126.882656
남구로,7호선,37.486056,126.887249
대림(구로구청),7호선,37.493013,126.897075
신풍,7호선,37.50008,126.90993
보라매,7호선,37.499872,126.920428
신대방삼거리,7호선,37.499701,126.928276
장승배기,7호선,37.504898,126.93915
상도,7호선,37.502834,126.94791
숭실대입구(살피재),7호선,37.496029,126.953822
남성,7호선,37.484596,126.971251
이수,7호선,37.485196,126.981605
내방,7호선,37.487618,126.993513
고속터미널,7호선,37.503367,127.005068
반포,7호선,37.508178,127.011727
논현,7호선,37.511093,127.021415
학동,7호선,37.514229,127.031656
강남구청,7호선,37.517179,127.041255
청담,7호선,37.519365,127.05335
뚝섬유원지,7호선,37.53154,127.066704
건대입구,7호선,37.540786,127.071011
어린이대공원(세종대),7호선,37.548014,127.074658
군자(능동),7호선,37.556897,127.079338
중곡,7호선,37.565923,127.08432
용마산,7호선,37.573647,127.086727
사가정,7호선,37.580894,127.088478
면목,7호선,37.588579,127.087503
상봉(시외버스터미널),7호선,37.595577,127.085716
중화,7호선,37.602545,127.079264
먹골,7호선,37.610637,127.077725
태릉입구,7호선,37.618294,127.075397
공릉(서울과학기술대),7호선,37.625742,127.072896
하계,7호선,37.636352,127.06799
중계,7호선,37.644583,127.064303
노원,7호선,37.654836,127.060462
마들,7호선,37.66494,127.057675
수락산,7호선,37.67785,127.055315
도봉산,7호선,37.689241,127.046509
장암,7호선,37.700109,127.053196
신내,6호선,37.613174,127.102231
봉화산(서울의료원),6호선,37.617283,127.091401
화랑대(서울여대입구),6호선,37.620064,127.084689
태릉입구,6호선,37.617338,127.074735
석계,6호선,37.614872,127.065595
돌곶이,6호선,37.610537,127.056431
상월곡(한국과학기술연구원),6호선,37.606377,127.048491
월곡(동덕여대),6호선,37.601948,127.041518
고려대(종암),6호선,37.590508,127.036296
안암(고대병원앞),6호선,37.586272,127.029005
보문,6호선,37.585274,127.019351
창신,6호선,37.579661,127.015241
동묘앞,6호선,37.572279,127.015653
신당,6호선,37.566154,127.016146
청구,6호선,37.560608,127.013986
약수,6호선,37.554263,127.010358
버티고개,6호선,37.548013,127.007055
한강진,6호선,37.539631,127.001725
이태원,6호선,37.534488,126.994302
녹사평(용산구청),6호선,37.534675,126.986695
삼각지,6호선,37.535534,126.974032
효창공원앞,6호선,37.539233,126.961384
공덕,6호선,37.543555,126.951678
대흥(서강대앞),6호선,37.547771,126.942069
광흥창(서강),6호선,37.547456,126.931993
상수,6호선,37.547716,126.922852
합정,6호선,37.549209,126.913366
망원,6호선,37.556094,126.910052
마포구청,6호선,37.563515,126.903343
월드컵경기장(성산),6호선,37.569532,126.899298
디지털미디어시티,6호선,37.576108,126.901391
증산(명지대앞),6호선,37.583876,126.909645
새절(신사),6호선,37.591148,126.913629
구산,6호선,37.611377,126.91727
연신내,6호선,37.618636,126.920625
독바위,6호선,37.618456,126.933031
불광,6호선,37.610873,126.92939
역촌,6호선,37.606021,126.922744
응암,6호선,37.598605,126.915577
하남검단산,5호선,37.53972,127.22345
하남시청(덕풍-신장),5호선,37.54205,127.20612
하남풍산,5호선,37.552034,127.203864
미사,5호선,37.560927,127.193877
강일,5호선,37.55749,127.17593
마천,5호선,37.49499,127.152781
거여,5호선,37.493105,127.14415
개롱,5호선,37.498079,127.13482
오금,5호선,37.502057,127.127938
방이,5호선,37.508857,127.126133
올림픽공원(한국체대),5호선,37.516201,127.130923
둔촌동,5호선,37.527788,127.136248
상일동,5호선,37.556712,127.166417
고덕,5호선,37.555004,127.154151
명일,5호선,37.55137,127.143999
굽은다리(강동구민회관앞),5호선,37.545477,127.142853
길동,5호선,37.537801,127.140004
강동,5호선,37.535804,127.132481
천호(풍납토성),5호선,37.53864,127.123308
광나루(장신대),5호선,37.545303,127.10357
아차산(어린이대공원후문),5호선,37.551691,127.089761
군자(능동),5호선,37.557088,127.079577
장한평,5호선,37.56144,127.064623
답십리,5호선,37.566747,127.052704
마장,5호선,37.5661,127.042973
왕십리(성동구청),5호선,37.56184,127.037059
행당,5호선,37.557322,127.029476
신금호,5호선,37.554548,127.020331
청구,5호선,37.560276,127.013639
동대문역사문화공원,5호선,37.564665,127.005353
을지로4가,5호선,37.567352,126.998032
종로3가,5호선,37.57254,126.990305
광화문(세종문화회관),5호선,37.571525,126.97717
서대문,5호선,37.565773,126.966641
충정로(경기대입구),5호선,37.560236,126.9629
애오개,5호선,37.553736,126.95682
공덕,5호선,37.544431,126.951372
마포,5호선,37.539574,126.945932
여의나루,5호선,37.527098,126.932901
여의도,5호선,37.521747,126.924357
신길,5호선,37.517623,126.914839
영등포시장,5호선,37.522669,126.905139
영등포구청,5호선,37.5242,126.89503
양평,5호선,37.525569,126.886129
오목교(목동운동장앞),5호선,37.524496,126.875181
목동,5호선,37.526065,126.864931
신정(은행정),5호선,37.524997,126.856191
까치산,5호선,37.531768,126.846683
화곡,5호선,37.541513,126.840461
우장산,5호선,37.548768,126.836318
발산,5호선,37.558598,126.837668
마곡,5호선,37.560183,126.825448
송정,5호선,37.561184,126.811973
김포공항,5호선,37.562384,126.801292
개화산,5호선,37.572399,126.806171
방화,5호선,37.577446,126.812741
부천종합운동장,서해선,37.505457,126.797289
원종,서해선,37.5239,126.8049
김포공항,서해선,37.5617,126.8041
대화,일산선,37.676087,126.747569
주엽,일산선,37.670072,126.761334
정발산,일산선,37.659477,126.773359
마두,일산선,37.652206,126.77762
백석,일산선,37.643114,126.78787
대곡,일산선,37.631626,126.811024
화정,일산선,37.634592,126.83265
원당,일산선,37.653324,126.843041
삼송,일산선,37.653083,126.895558
지축,일산선,37.648017,126.91397
원흥,일산선,37.650658,126.872642
연천,경원선,38.10073,127.07372
전곡,경원선,38.02458,127.0718
청산,경원선,37.98172,127.06912
소요산,경원선,37.9481,127.061034
동두천,경원선,37.927878,127.05479
보산,경원선,37.913702,127.057277
동두천중앙,경원선,37.901885,127.056482
지행,경원선,37.892334,127.055716
덕정,경원선,37.843188,127.061277
덕계,경원선,37.818486,127.056486
양주,경원선,37.774381,127.044708
녹양,경원선,37.75938,127.042292
가능,경원선,37.748577,127.044213
의정부,경원선,37.738415,127.045958
회룡,경원선,37.724416,127.04736
망월사,경원선,37.709914,127.047455
도봉산,경원선,37.689534,127.046049
도봉,경원선,37.679563,127.045595
방학,경원선,37.667503,127.044273
인천,수인선,37.476403,126.617326
신포,수인선,37.46874,126.623853
숭의,수인선,37.460789,126.638297
인하대,수인선,37.448493,126.649619
송도,수인선,37.428514,126.657772
연수,수인선,37.417804,126.67894
원인재,수인선,37.413049,126.686648
남동인더스파크,수인선,37.407722,126.695216
호구포,수인선,37.401637,126.708627
인천논현,수인선,37.400614,126.722478
소래포구,수인선,37.40095,126.733522
월곶,수인선,37.391769,126.742699
달월,수인선,37.379681,126.745177
사리,수인선,37.28998,126.85685
야목,수인선,37.264179,126.879483
어천,수인선,37.250102,126.90879
오목천,수인선,37.24304,126.963676
고색,수인선,37.24963,126.980248
매교,분당선,37.265481,127.015678
수원시청,분당선,37.261911,127.030736
매탄권선,분당선,37.252759,127.040566
망포,분당선,37.245795,127.057353
영통,분당선,37.251568,127.071394
청명,분당선,37.259489,127.078934
상갈,분당선,37.26181,127.108847
기흥,분당선,37.275061,127.11591
신갈,분당선,37.286102,127.111313
구성,분당선,37.298969,127.105664
죽전,분당선,37.324753,127.107395
보정,분당선,37.312752,127.108196
이매,분당선,37.395371,127.128248
오리,분당선,37.339824,127.108942
미금,분당선,37.350077,127.10891
정자,분당선,37.365994,127.10807
수내,분당선,37.378455,127.114322
서현,분당선,37.385126,127.123592
야탑,분당선,37.411185,127.128715
모란,분당선,37.432052,127.129104
태평,분당선,37.440019,127.127709
가천대,분당선,37.448605,127.126697
선정릉,분당선,37.510735,127.043677
강남구청,분당선,37.517469,127.041151
압구정로데오,분당선,37.527381,127.040534
서울숲,분당선,37.543617,127.044707
수원,분당선,37.265917,126.999422
도화,경인선,37.46607,126.668672
중동,경인선,37.486562,126.764843
온수(성공회대입구),경인선,37.492433,126.824086
도원,경인선,37.468446,126.642706
간석,경인선,37.464737,126.694181
부개,경인선,37.488418,126.74109
소사,경인선,37.482753,126.79544
구일,경인선,37.496756,126.870793
인천,경인선,37.476079,126.616801
동인천,경인선,37.475276,126.632802
제물포,경인선,37.466769,126.656666
주안,경인선,37.465047,126.679742
동암,경인선,37.471408,126.702896
백운,경인선,37.483664,126.707704
부평,경인선,37.489445,126.724506
송내,경인선,37.4876,126.753664
부천,경인선,37.48405,126.782686
역곡,경인선,37.485178,126.811502
오류동,경인선,37.494526,126.845365
개봉,경인선,37.494594,126.85968
수리산,안산선,37.349801,126.925365
오이도,안산선,37.362357,126.738714
정왕,안산선,37.351735,126.742989
신길온천,안산선,37.338212,126.765844
안산,안산선,37.327082,126.788532
초지,안산선,37.320646,126.805913
고잔,안산선,37.316784,126.823144
중앙,안산선,37.315941,126.838573
한대앞,안산선,37.309689,126.85344
상록수,안산선,37.302795,126.866489
반월,안산선,37.312212,126.903524
대야미,안산선,37.328467,126.917332
산본,안산선,37.358101,126.933274
광명,경부선,37.416182,126.884466
서동탄,경부선,37.195504,127.051672
당정,경부선,37.344285,126.948345
천안,경부선,36.810005,127.146826
두정,경부선,36.833705,127.14896
직산,경부선,36.870593,127.143904
성환,경부선,36.916076,127.126964
평택,경부선,36.990726,127.085159
지제,경부선,37.0188,127.070444
서정리,경부선,37.056496,127.052819
송탄,경부선,37.075696,127.054301
진위,경부선,37.109447,127.062278
오산,경부선,37.145885,127.06672
오산대,경부선,37.168953,127.063197
세마,경부선,37.187533,127.04318
병점,경부선,37.207503,127.032731
세류,경부선,37.245025,127.013222
독산,경부선,37.466613,126.889249
수원,경부선,37.266348,126.999561
화서,경부선,37.283862,126.989627
성균관대,경부선,37.300349,126.97075
의왕,경부선,37.320852,126.948217
군포,경부선,37.35356,126.948462
금정,경부선,37.372221,126.943429
명학,경부선,37.384653,126.935433
안양,경부선,37.401592,126.922874
관악,경부선,37.419232,126.908706
석수,경부선,37.435047,126.902295
금천구청,경부선,37.455626,126.89398
가산디지털단지,경부선,37.481581,126.882581
구로,경부선,37.503039,126.881966
성남,경강선,37.39468,127.11945
여주,경강선,37.282308,127.628816
세종대왕릉,경강선,37.295309,127.570938
부발,경강선,37.260192,127.490277
이천,경강선,37.265579,127.44226
신둔도예촌,경강선,37.317185,127.40476
곤지암,경강선,37.351315,127.34674
초월,경강선,37.374419,127.299
경기광주,경강선,37.399907,127.25263
삼동,경강선,37.409522,127.20336
이매,경강선,37.394655,127.127819
판교,경강선,37.394761,127.111217
금정,과천선,37.372209,126.943417
범계,과천선,37.389793,126.950806
평촌,과천선,37.394287,126.963883
인덕원,과천선,37.401553,126.976715
정부과천청사,과천선,37.426513,126.98978
과천,과천선,37.433021,126.996568
대공원,과천선,37.435675,127.006523
경마공원,과천선,37.443885,127.007888
선바위,과천선,37.451673,127.002303
신창(순천향대),장항선,36.769502,126.951108
온양온천,장항선,36.780483,127.003249
배방,장항선,36.777629,127.052991
탕정,장항선,36.78866,127.08485
아산,장항선,36.792053,127.104361
쌍용(나사렛대),장항선,36.793759,127.1214
봉명,장항선,36.801215,127.135763
춘천,경춘선,37.885054,127.717023
남춘천,경춘선,37.864007,127.723792
김유정,경춘선,37.818466,127.71434
강촌,경춘선,37.805723,127.634146
백양리,경춘선,37.830779,127.58933
굴봉산,경춘선,37.832067,127.557695
가평,경춘선,37.814536,127.510739
상천,경춘선,37.770246,127.454821
청평,경춘선,37.735488,127.42661
대성리,경춘선,37.684071,127.379319
마석,경춘선,37.652782,127.311767
천마산,경춘선,37.658978,127.285379
평내호평,경춘선,37.653225,127.244493
금곡,경춘선,37.637382,127.207853
사릉,경춘선,37.65108,127.176933
퇴계원,경춘선,37.648311,127.143952
별내,경춘선,37.64202,127.12684
갈매,경춘선,37.634118,127.114757
신내,경춘선,37.612887,127.103218
운천,경의중앙선,37.879942,126.769999
임진강,경의중앙선,37.888421,126.746765
문산,경의중앙선,37.854619,126.788047
파주,경의중앙선,37.815298,126.792783
월롱,경의중앙선,37.796188,126.792587
금촌,경의중앙선,37.766217,126.774644
금릉,경의중앙선,37.751322,126.765347
운정,경의중앙선,37.725826,126.767257
야당,경의중앙선,37.712327,126.761356
탄현,경의중앙선,37.694023,126.761086
일산,경의중앙선,37.682077,126.769846
풍산,경의중앙선,37.672346,126.786243
백마,경의중앙선,37.658239,126.794461
곡산,경의중앙선,37.645676,126.801762
능곡,경의중앙선,37.618808,126.820783
행신,경의중앙선,37.612102,126.834146
강매,경의중앙선,37.612314,126.843223
화전,경의중앙선,37.602888,126.868387
수색,경의중앙선,37.580842,126.895611
디지털미디어시티,경의중앙선,37.577475,126.900453
가좌,경의중앙선,37.568491,126.915487
홍대입구,경의중앙선,37.557641,126.926683
서강대,경의중앙선,37.551881,126.935711
공덕,경의중앙선,37.542596,126.952099
효창공원앞,경의중앙선,37.538579,126.96221
신촌,경의중앙선,37.559733,126.942597
서울역,경의중앙선,37.557231,126.97103
지평,중앙선,37.476393,127.629874
용문,중앙선,37.48223,127.594647
원덕,중앙선,37.468672,127.547076
양평,중앙선,37.492773,127.491837
오빈,중앙선,37.506062,127.473868
아신,중앙선,37.51382,127.443173
국수,중앙선,37.516169,127.399367
신원,중앙선,37.525545,127.372921
양수,중앙선,37.545981,127.329098
운길산,중앙선,37.554669,127.310115
팔당,중앙선,37.547371,127.243939
도심,중앙선,37.579622,127.222672
덕소,중앙선,37.586781,127.208832
양정,중앙선,37.60533,127.19364
도농,중앙선,37.608806,127.161153
구리,중앙선,37.603392,127.143869
양원,중앙선,37.606596,127.107906
망우,중앙선,37.59955,127.091909
상봉(시외버스터미널),중앙선,37.596678,127.08504
중랑,중앙선,37.594917,127.076116
신길,경부선,37.516862,126.917865
수서,분당선,37.487472,127.101422
대모산입구,분당선,37.491373,127.07272
개포동,분당선,37.489116,127.06614
구룡,분당선,37.486839,127.058856
도곡,분당선,37.491224,127.055186
한티,분당선,37.496237,127.052873
선릉,분당선,37.504856,127.048807
녹천,경원선,37.644799,127.051269
월계,경원선,37.633212,127.058831
광운대,경원선,37.623632,127.061835
석계,경원선,37.614532,127.065934
신이문,경원선,37.601854,127.067325
외대앞,경원선,37.596073,127.063549
회기,중앙선,37.58946,127.057583
청량리(서울시립대입구),경원선,37.580759,127.0483
왕십리(성동구청),경원선,37.561827,127.038352
응봉,경원선,37.549946,127.034538
옥수,경원선,37.540446,127.018672
한남,경원선,37.52943,127.009169
서빙고,경원선,37.519594,126.988537
이촌(국립중앙박물관),경원선,37.522427,126.973406
신도림,경부선,37.508787,126.891144
영등포,경부선,37.515504,126.907628
대방,경부선,37.513342,126.926382
노량진,경부선,37.514149,126.94271
용산,경부선,37.529849,126.964561
남영,경부선,37.541021,126.9713
서울역,경부선,37.554337,126.971134
남태령,4호선,37.463873,126.989134
사당,4호선,37.476955,126.981651
총신대입구(이수),4호선,37.486263,126.981989
동작(현충원),4호선,37.502852,126.980347
이촌(국립중앙박물관),4호선,37.522295,126.974733
신용산,4호선,37.52917,126.967894
삼각지,4호선,37.534075,126.9726
숙대입구(갈월),4호선,37.54456,126.972106
서울역,4호선,37.55281,126.972556
회현(남대문시장),4호선,37.558514,126.978246
명동,4호선,37.560989,126.986325
충무로,4호선,37.561207,126.99408
동대문역사문화공원,4호선,37.565133,127.007885
동대문,4호선,37.57093,127.009287
혜화,4호선,37.582336,127.001844
한성대입구(삼선교),4호선,37.588458,127.006221
성신여대입구(돈암),4호선,37.592612,127.016441
길음,4호선,37.603407,127.025053
미아사거리,4호선,37.613292,127.030053
미아(서울사이버대학),4호선,37.62667,127.025983
수유(강북구청),4호선,37.638052,127.025732
쌍문,4호선,37.648627,127.034709
창동,4호선,37.653088,127.047274
노원,4호선,37.65627,127.063276
상계,4호선,37.660878,127.073572
불암산,4호선,37.670272,127.079066
별내별가람,진접선,37.66778,127.11581
오남,진접선,37.705,127.19281
진접,진접선,37.7205,127.2034
오금,3호선,37.502129,127.128319
경찰병원,3호선,37.495918,127.12454
가락시장,3호선,37.492245,127.117757
수서,3호선,37.487378,127.101907
일원,3호선,37.483681,127.08439
대청,3호선,37.493514,127.079532
학여울,3호선,37.496663,127.070594
대치,3호선,37.494612,127.063642
도곡,3호선,37.490922,127.055452
매봉,3호선,37.486947,127.046769
양재(서초구청),3호선,37.484477,127.033902
남부터미널(예술의전당),3호선,37.485013,127.016189
교대(법원.검찰청),3호선,37.493025,127.013786
고속터미널,3호선,37.504891,127.004916
잠원,3호선,37.512759,127.01122
신사,3호선,37.516334,127.020114
압구정,3호선,37.527072,127.028461
옥수,3호선,37.541684,127.017269
금호,3호선,37.548034,127.015872
약수,3호선,37.554867,127.010541
동대입구,3호선,37.559052,127.005602
충무로,3호선,37.56143,126.994072
을지로3가,3호선,37.566672,126.992548
종로3가,3호선,37.571605,126.991791
안국,3호선,37.576477,126.985443
경복궁(정부서울청사),3호선,37.575762,126.97353
독립문,3호선,37.574571,126.957748
무악재,3호선,37.582299,126.950291
홍제,3호선,37.589066,126.943736
녹번,3호선,37.600927,126.935756
불광,3호선,37.610553,126.92982
연신내,3호선,37.619229,126.921038
구파발,3호선,37.636763,126.918821
지축,3호선,37.648033,126.913917
용두(동대문구청),2호선,37.574028,127.038091
신정네거리,2호선,37.520074,126.852912
양천구청,2호선,37.512398,126.865819
도림천,2호선,37.514287,126.882768
신설동,2호선,37.574747,127.024932
신답,2호선,37.57004,127.046481
용답,2호선,37.561904,127.050899
충정로(경기대입구),2호선,37.559704,126.964378
아현,2호선,37.557345,126.956141
이대,2호선,37.556733,126.946013
신촌,2호선,37.555131,126.936926
홍대입구,2호선,37.55679,126.923708
합정,2호선,37.549457,126.913808
당산,2호선,37.534946,126.902767
영등포구청,2호선,37.525706,126.89661
문래,2호선,37.517933,126.89476
신도림,2호선,37.508961,126.891084
대림(구로구청),2호선,37.493243,126.894932
구로디지털단지,2호선,37.485266,126.901401
신대방,2호선,37.487462,126.913149
신림,2호선,37.484201,126.929715
봉천,2호선,37.482362,126.941892
서울대입구(관악구청),2호선,37.481247,126.952739
낙성대,2호선,37.47693,126.963693
사당,2호선,37.476538,126.981544
방배,2호선,37.481426,126.997596
서초,2호선,37.491897,127.007917
교대(법원.검찰청),2호선,37.493961,127.014667
강남,2호선,37.49799,127.027912
역삼,2호선,37.500622,127.036456
선릉,2호선,37.504286,127.048203
삼성(무역센터),2호선,37.508844,127.06316
종합운동장,2호선,37.511022,127.073704
잠실새내,2호선,37.511687,127.086162
잠실(송파구청),2호선,37.513262,127.100159
잠실나루,2호선,37.520733,127.10379
강변(동서울터미널),2호선,37.535095,127.094681
구의(광진구청),2호선,37.537077,127.085916
건대입구,2호선,37.540373,127.069191
성수,2호선,37.544581,127.055961
뚝섬,2호선,37.547184,127.047367
한양대,2호선,37.555273,127.043655
왕십리(성동구청),2호선,37.561238,127.036954
상왕십리,2호선,37.564354,127.029354
신당,2호선,37.56564,127.019614
동대문역사문화공원,2호선,37.565613,127.009054
을지로4가,2호선,37.566595,126.997817
을지로3가,2호선,37.566306,126.991696
을지로입구,2호선,37.566014,126.982618
시청,2호선,37.563588,126.975411
동묘앞,1호선,37.573197,127.01648
청량리(서울시립대입구),1호선,37.579956,127.044585
제기동,1호선,37.578103,127.034893
신설동,1호선,37.576048,127.024634
동대문,1호선,37.571687,127.01093
종로5가,1호선,37.570926,127.001849
종로3가,1호선,37.570406,126.991847
종각,1호선,37.570161,126.982923
시청,1호선,37.565715,126.977088
서울역,1호선,37.556228,126.972135
"""
@st.cache_resource
def load_station_master_from_embedded() -> pd.DataFrame:
    df = pd.read_csv(StringIO(STATION_CSV))
    df["lat"] = pd.to_numeric(df["lat"], errors="coerce")
    df["lon"] = pd.to_numeric(df["lon"], errors="coerce")
    return df.dropna(subset=["lat","lon"]).reset_index(drop=True)

def _haversine_vec(lat, lon, lats, lons):
    R = 6371000.0
    lat1 = np.radians(lat); lon1 = np.radians(lon)
    lat2 = np.radians(lats); lon2 = np.radians(lons)
    dlat = lat2 - lat1; dlon = lon2 - lon1
    a = np.sin(dlat/2.0)**2 + np.cos(lat1)*np.cos(lat2)*np.sin(dlon/2.0)**2
    return 2.0 * R * np.arcsin(np.sqrt(a))

def nearest_station(lat: float, lon: float, stations: pd.DataFrame):
    if stations is None or stations.empty: return None
    d = _haversine_vec(lat, lon, stations["lat"].to_numpy(), stations["lon"].to_numpy())
    if d.size == 0 or np.all(np.isnan(d)): return None
    idx = int(np.nanargmin(d))
    return {
        "name": str(stations.at[idx,"name"]),
        "line": str(stations.at[idx,"line"]),
        "lat": float(stations.at[idx,"lat"]),
        "lon": float(stations.at[idx,"lon"]),
        "dist": int(round(float(d[idx]))),
    }

# ───────────────────────────
# 유틸: 카테고리/지오코딩
# ───────────────────────────
def hash01_djb2(s: str) -> float:
    h = 5381
    for ch in str(s): h = ((h << 5) + h) + ord(ch)
    return float((h & 0xFFFFFFFF) / 0xFFFFFFFF)

ENCODING = {"건물용도": {"단독다가구": 0, "아파트": 1, "연립다세대": 2, "오피스텔": 3}}
def enc_category(name: str, raw: str) -> float:
    table = ENCODING.get(name)
    if table and raw in table: return float(table[raw])
    return hash01_djb2(raw)

def geocode_osm(q: str):
    url = "https://nominatim.openstreetmap.org/search"
    params = {"format":"jsonv2","limit":1,"addressdetails":1,"countrycodes":"kr","q":q}
    headers = {"Accept":"application/json","Accept-Language":"ko","User-Agent":"jeonse-streamlit/1.0"}
    r = requests.get(url, params=params, headers=headers, timeout=15); r.raise_for_status()
    arr = r.json()
    if not arr: return None
    j = arr[0]
    return {"lat": float(j["lat"]), "lon": float(j["lon"]), "address": j.get("address", {}), "display": j.get("display_name","")}

def parse_kr(address: dict):
    gu = address.get("county") or address.get("city_district") or address.get("borough") or address.get("city") or ""
    dong = address.get("suburb") or address.get("neighbourhood") or address.get("quarter") or address.get("village") or address.get("town") or ""
    return gu, dong

# ───────────────────────────
# 세션 기본값
# ───────────────────────────
st.session_state.setdefault("lat", 37.5665)
st.session_state.setdefault("lon", 126.9780)
st.session_state.setdefault("gu", "")
st.session_state.setdefault("dong", "")
st.session_state.setdefault("addr_state", "")

# ───────────────────────────
# 입력 폼
# ───────────────────────────
with st.form("inputs"):
    c1, c2, c3 = st.columns(3)
    with c1:
        bldg = st.selectbox("건물용도", ["단독다가구","아파트","연립다세대","오피스텔"], index=1)
        floor = st.number_input("층 수", value=3, step=1, min_value=-5, max_value=100)
        area = st.number_input("임대면적(㎡)", value=84.0, min_value=0.0, step=0.1)
    with c2:
        addr = st.text_input("주소(지오코딩)", value=st.session_state.get("addr_state","서울특별시 중구 세종대로 110"))
        contract = st.date_input("계약일", value=date.today(), format="YYYY-MM-DD")
        build_year = st.number_input("건축년도", value=2005, step=1, min_value=1900, max_value=2100)
    with c3:
        st.caption("주소로 좌표를 찾고 내장 역 목록으로 최근접 역/거리 계산")
    run = st.form_submit_button("좌표/역 자동계산")

if run:
    st.session_state.addr_state = addr.strip()
    if st.session_state.addr_state:
        g = geocode_osm(st.session_state.addr_state)
        if g:
            st.session_state.lat = g["lat"]; st.session_state.lon = g["lon"]
            st.session_state.gu, st.session_state.dong = parse_kr(g["address"])
            st.session_state.addr_state = g["display"] or st.session_state.addr_state
            st.success(f"좌표: {st.session_state.lat:.6f}, {st.session_state.lon:.6f} | {st.session_state.gu} / {st.session_state.dong}")
        else:
            st.warning("주소 결과 없음")

# ───────────────────────────
# 지도 표시
# ───────────────────────────
cur_lat = float(st.session_state.lat); cur_lon = float(st.session_state.lon)
stations_df = load_station_master_from_embedded()
near = nearest_station(cur_lat, cur_lon, stations_df)

m = folium.Map(location=[cur_lat, cur_lon], zoom_start=15, control_scale=True)
folium.Marker([cur_lat, cur_lon], tooltip="선택 지점",
              icon=folium.Icon(color="blue", icon="home", prefix="fa")).add_to(m)

if near:
    folium.Marker([near["lat"], near["lon"]],
                  tooltip=f"최근접 역: {near['name']} ({near['line']})",
                  icon=folium.Icon(color="red", icon="train", prefix="fa")).add_to(m)
    folium.PolyLine([[cur_lat, cur_lon], [near["lat"], near["lon"]]], color="red", weight=2, opacity=0.7).add_to(m)

st_folium(m, height=430, width=None)

# ───────────────────────────
# 자동 파생값 표시
# ───────────────────────────
recv_year = contract.year
bldg_age = recv_year - int(build_year)
st.info(
    f"자치구/동: {st.session_state.gu or '-'} / {st.session_state.dong or '-'}   ·   "
    f"최근접 지하철: {near['name']} ({near['line']}) / {near['dist']} m" if near else "최근접 지하철: -"
)

# ───────────────────────────
# 예측 실행
# ───────────────────────────
model = load_model()
feat_names = get_feature_names_from_booster(model)

st.divider()
if st.button("예측하기"):
    if not feat_names:
        st.error("모델 feature_names를 찾지 못했습니다. 'jeonse_gbm_xgb.flist' 등을 같은 폴더에 두거나 모델에 내장하세요.")
        st.stop()

    feat = {
        "건물용도": enc_category("건물용도", bldg),
        "임대면적": float(area),
        "동_norm": hash01_djb2(st.session_state.dong or ""),
        "구_norm": hash01_djb2(st.session_state.gu or ""),
        "건축년도": int(build_year),
        "최근접_지하철역": hash01_djb2(near["name"]) if near else 0.0,
        "최근접_호선": hash01_djb2(near["line"]) if near else 0.0,
        "계약일": int(f"{contract.year}{contract.month:02d}{contract.day:02d}"),
        "계약일_year": int(contract.year),
        "계약일_month": int(contract.month),
        "lon": float(cur_lon),
        "lat": float(cur_lat),
        "건물연령": int(bldg_age),
        "층": int(floor),
        "접수년도": int(contract.year),
        "지하철역까지 직선거리": int(near["dist"]) if near else 0,
    }

    df = pd.DataFrame([feat]).astype(np.float32)

    missing = [c for c in feat_names if c not in df.columns]
    extra   = [c for c in df.columns if c not in feat_names]
    if missing:
        st.error(f"모델이 요구하는 피처 누락: {missing}")
        if extra: st.info(f"모델에 없는 추가 피처: {extra}")
        st.stop()

    X = df.reindex(columns=feat_names)
    dmat = xgb.DMatrix(X, feature_names=feat_names)
    y = model.predict(dmat)
    y_val = float(y[0])

    st.success(f"예측 전세 보증금: {int(round(y_val)):,} 만원")

    with st.expander("입력 피처 미리보기"):
        st.code(json.dumps(feat, ensure_ascii=False, indent=2), language="json")
